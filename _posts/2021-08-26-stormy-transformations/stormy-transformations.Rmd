---
title: "Stormy Transformations"
description: |
  A short description of the post.
author:
  - name: Nils Ratnaweera
    url: {}
draft: false
output:
  distill::distill_article:
    self_contained: false
---


When I started working geodata a couple of years ago, Switzerland was beginning to  transition from it's old coordinate system `CH1903 LV03` to `CH1903+ LV95` (EPSG 2056). The new coordinate system was awkward from the start. First off, I suddenly was un unable to convert data from WGS84 using a custom R script that swisstopo had previously provided for `CH1903 LV03`. The answer to [my question on a swisstopo google group (in 2017)](https://groups.google.com/g/geoadmin-api/c/dkA-JCdyGLw/m/jid3Sx_oFAAJ) was to use swisstopo's REST api.

This problem was seemingly solved with the emergence of `sf` and it's built in methods to reproject coordinates easily. Until one day I realized that the coordinate transformations to and from EPSG 2056 were fairly imprecise. The transformations did not account for the spatially varying offset for which the new coordinate system was implemented in the first place.  

I filed [an issue on `sf` github repo](https://github.com/r-spatial/sf/issues/1292) beginning of 2020, but it wasn't until recently (wiht PROJ 7.0.0) that I was able to precisely transform my data to and from EPSG 2056. 

[Roger Bivand](https://github.com/r-spatial/sf/issues/1292#issuecomment-595089209) was able to pinpoint the issue using the function `list_coordOps()` from `rgdal`. Apparently, the transformation was lacking a grid with the name `ch_swisstopo_CHENyx06a.tif`.

```{r, eval = FALSE}
rgdal::list_coordOps("EPSG:21781", "EPSG:2056")
```

```
Candidate coordinate operations found:  2 
Strict containment:  FALSE 
Visualization order:  TRUE 
Source: EPSG:21781 
Target: EPSG:2056 
Best instantiable operation has only ballpark accuracy 
Description: Inverse of Swiss Oblique Mercator 1903M + Ballpark geographic 
offset from CH1903 to CH1903+ + Swiss Oblique Mercator
             1995
Definition:  +proj=pipeline +step +inv +proj=somerc +lat_0=46.9524055555556 +lon_0=7.43958333333333 +k_0=1 +x_0=600000
             +y_0=200000 +ellps=bessel +step +proj=somerc +lat_0=46.9524055555556 +lon_0=7.43958333333333 +k_0=1
             +x_0=2600000 +y_0=1200000 +ellps=bessel
Operation 1 is lacking 1 grid with accuracy 0.2 m
Missing grid: ch_swisstopo_CHENyx06a.tif 
URL: https://cdn.proj.org/ch_swisstopo_CHENyx06a.tif 
```

With my current version of `sf` and `rgdal`, I need to download this grid manually and copy it to the PROJ directory. Running `list_coordOps` now shows a different output.

```{bash, eval = FALSE}
wget https://cdn.proj.org/ch_swisstopo_CHENyx06a.tif
sudo mv ch_swisstopo_CHENyx06a.tif /usr/share/proj/
```

```{r}
rgdal::list_coordOps("EPSG:21781", "EPSG:2056")
```

Now I can visualize how the new coordinate system is different from the old. 

```{r}
library(sf)
library(dplyr)
library(ggplot2)
library(tidyr)

make_grid <- function(cellsize, land){
  
  land <- st_transform(land, 2056)
  
  gri <- st_make_grid(land, cellsize, what = "centers")

  gri2 <- st_transform(gri, 21781)
  
  mat <- cbind(
    st_coordinates(gri),
    st_coordinates(gri2)
  )
  
  colnames(mat) <- c("E", "N", "X", "Y")
  
  mat %>%
    tibble::as_tibble() %>%
    mutate(
      E_fic = (X+2e6),
      N_fic = (Y+1e6),
      E_norm = E - E_fic,
      N_norm = N - N_fic,
      dist = (E_norm^2+N_norm^2)^0.5,
      heading = atan2(N_norm, E_norm),
      h = heading*180/pi,
      heading_deg = case_when(
        h>=0 & h<=90~90-h,
        h>90~450-h,
        TRUE~abs(h) + 90
      )
    )
  
}
```


```{r}
landesgebiet <- read_sf("data-git-lfs/swissboundaries/swissBOUNDARIES3D_1_3_TLM_LANDESGEBIET.shp")

```


```{r}
df <- make_grid(1000, landesgebiet)
colo <- paste0("#",c("EF476F","FFD166","06D6A0", "118AB2","EF476F"))


bb_ch <- landesgebiet %>%
  st_bbox() %>%
  st_as_sfc() %>%
  st_buffer(5000) %>%
  st_difference(st_union(landesgebiet))

markers <- tribble(
  ~E, ~N, ~name,
  2598633.750, 1200386.750, "Bern",
  2682217.000, 1247945.250 , "ZÃ¼rich"
)

p1 <- ggplot(df, aes(E, N)) +
  geom_raster(aes(fill = heading_deg)) +
  scale_fill_gradientn(colors = colo)+
  theme_void() +
  scale_alpha_continuous(range = c(0.5, 1)) +
  geom_sf(data = bb_ch, inherit.aes = FALSE, fill = "white", color = "NA") +
  geom_sf(data = landesgebiet, fill = "NA", inherit.aes = FALSE) +
  theme(legend.position = "none") +
  geom_point(data = markers) +
  geom_text(data = markers, aes(label = name),nudge_x = 15000, nudge_y = -15000) +
  labs(title = "Transitioning from EPSG 21781 to 2056",
       subtitle = "in which direction is the offset?"
         )


legend_df <- tibble(x = seq(1, 360, 1))  %>%
  mutate(id = x,
         xend = lead(x)) %>%
  pivot_longer(starts_with("x"),values_to = "x") %>%
  select(-name) %>%
  crossing(y = c(1,2)) %>%
  group_by(id) %>%
  mutate(
    angle = atan2(x-mean(x),y-mean(y))
  ) %>%
  arrange(id, angle) 

legend_plot <- ggplot(legend_df) +
  geom_polygon(aes(x, y, fill = id, group = id)) +
  scale_fill_gradientn(colors = colo)+
  scale_y_continuous(limits = c(0,2)) +
  scale_x_continuous(breaks = c(90,180,270,360),
                     labels = c("E","S","W","N")) +
  coord_polar() +
  theme(legend.position = "none",
        panel.background = element_blank(),
        axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        plot.background = element_blank())
```


```{r, layout="l-page"}
library(cowplot)
ggdraw(p1) +
  draw_plot(legend_plot, .99, .99, .3, .3, scale = 1, 
            hjust = 1,vjust = 1, halign = 1, valign = 3)
```


```{r, echo = FALSE, eval = FALSE}

df2 <- make_grid(4000, landesgebiet)

ggplot(df2, aes(E_fic,N_fic, color = dist, alpha = dist)) +
  geom_point(size = 0.1) +
  geom_spoke(aes(angle = heading, radius = scales::rescale(dist, 5e3, 10e3))) +
  geom_sf(data = landesgebiet, inherit.aes = FALSE, fill = "NA") +
  scale_color_gradient(low = "blue", high = "red") +
  theme_void() +
  theme(legend.position = "bottom")


ggplot(df2, aes(E_fic,N_fic, color = dist)) +
  geom_point(size = 0.4) +
  geom_spoke(aes(angle = heading),arrow=arrow(length = unit(0.2,"cm")), radius = 1) +
  geom_sf(data = landesgebiet, inherit.aes = FALSE, fill = "NA") +
  scale_color_gradient(low = "blue", high = "red") +
  theme_void()+
  theme(legend.position = "bottom")

```


